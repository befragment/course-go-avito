#!/usr/bin/env bash

set -euo pipefail

commit_msg_file="$1"
first_line="$(sed -n '1p' "$commit_msg_file" | tr -d '\r')"

# Allow merge commits and empty (e.g., --allow-empty-message with -m "")
if [[ "$first_line" =~ ^Merge\  ]]; then
  exit 0
fi

# Conventional Commits pattern
# type(scope)!: subject
# - type: feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert
# - scope: optional, lowercase [a-z0-9-\/] chars
# - !: optional breaking change marker
# - subject: non-empty, any chars except leading space
pattern='^(revert: )?(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-z0-9\-\/]+\))?(!)?: [^ ].*$'

if ! printf '%s' "$first_line" | grep -Eq "$pattern"; then
  cat >&2 <<'EOF'
Conventional Commits required.

Format: type(scope)!: subject
Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert

Examples:
  feat(api): add courier GET
  fix(db)!: switch placeholders to $1 format
  chore: update dependencies
EOF
  echo "Given: "$first_line"" >&2
  exit 1
fi

# Enforce short subject (<= 72 chars)
subject="$(printf '%s' "$first_line" | sed -E 's/^(revert: )?[^:]+: //')"
if [ ${#subject} -gt 72 ]; then
  echo "Subject too long (>72 chars). Current: ${#subject}" >&2
  exit 1
fi

exit 0


